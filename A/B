
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Malaysian Passport Photo</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- FontAwesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;800&display=swap" rel="stylesheet">
    <!-- jsPDF for PDF generation -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
        }
        
        /* Custom scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #f1f1f1; 
        }
        ::-webkit-scrollbar-thumb {
            background: #888; 
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #555; 
        }

        .step-card {
            transition: all 0.3s ease;
        }
        .step-card:hover {
            transform: translateY(-5px);
        }

        /* Canvas container styles */
        .canvas-container {
            position: relative;
            overflow: hidden;
            background-image: 
                linear-gradient(45deg, #ccc 25%, transparent 25%), 
                linear-gradient(-45deg, #ccc 25%, transparent 25%), 
                linear-gradient(45deg, transparent 75%, #ccc 75%), 
                linear-gradient(-45deg, transparent 75%, #ccc 75%);
            background-size: 20px 20px;
            background-position: 0 0, 0 10px, 10px -10px, -10px 0px;
            background-color: white;
            cursor: grab;
            touch-action: none; /* Prevent scrolling while dragging */
        }
        
        .canvas-container:active {
            cursor: grabbing;
        }

        /* The overlay that shows the passport size cut-out */
        .overlay-guide {
            pointer-events: none;
            opacity: 0.4;
            transition: opacity 0.3s;
        }
        .canvas-container:hover .overlay-guide {
            opacity: 0.6;
        }

        /* Modal Styles */
        .modal {
            display: none;
            position: fixed;
            z-index: 50;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.8);
            align-items: center;
            justify-content: center;
        }
        .modal.flex {
            display: flex;
        }
        .modal-content {
            background-color: #fefefe;
            padding: 20px;
            border-radius: 12px;
            max-width: 90%;
            max-height: 90vh;
            overflow-y: auto;
            text-align: center;
            position: relative;
        }

        /* Glitter Effect */
        .btn-glitter {
            position: relative;
            overflow: hidden;
        }
        .btn-glitter::after {
            content: "";
            position: absolute;
            top: 0;
            left: -100%;
            width: 50%;
            height: 100%;
            background: linear-gradient(
                to right,
                rgba(255, 255, 255, 0) 0%,
                rgba(255, 255, 255, 0.6) 50%,
                rgba(255, 255, 255, 0) 100%
            );
            transform: skewX(-25deg);
            animation: shine 3s infinite;
        }

        @keyframes shine {
            0% { left: -100%; }
            20% { left: 200%; }
            100% { left: 200%; }
        }

        /* Wiggle Effect */
        .wiggle-container {
            animation: wiggle 2s ease-in-out infinite;
            display: inline-block;
        }
        
        @keyframes wiggle {
            0%, 100% { transform: rotate(0deg); }
            25% { transform: rotate(-3deg); }
            75% { transform: rotate(3deg); }
        }

        /* Language Button Active State */
        .lang-btn.active {
            background-color: white;
            color: #1e3a8a; /* blue-900 */
        }
        .lang-btn {
            background-color: rgba(255,255,255,0.2);
            color: white;
        }

        /* Toast Notification */
        #toast {
            visibility: hidden;
            min-width: 250px;
            background-color: #333;
            color: #fff;
            text-align: center;
            border-radius: 8px;
            padding: 16px;
            position: fixed;
            z-index: 100;
            left: 50%;
            bottom: 30px;
            transform: translateX(-50%);
            font-size: 14px;
            opacity: 0;
            transition: opacity 0.3s, bottom 0.3s;
            box-shadow: 0 4px 6px rgba(0,0,0,0.3);
        }

        #toast.show {
            visibility: visible;
            opacity: 1;
            bottom: 50px;
        }

        /* Feedback Button Pulse */
        .pulse-btn {
            animation: pulse-shadow 2s infinite;
        }
        @keyframes pulse-shadow {
            /* Updated to Yellow RGBA (250, 204, 21) to match bg-yellow-400 */
            0% { box-shadow: 0 0 0 0 rgba(250, 204, 21, 0.7); }
            70% { box-shadow: 0 0 0 10px rgba(250, 204, 21, 0); }
            100% { box-shadow: 0 0 0 0 rgba(250, 204, 21, 0); }
        }
    </style>
</head>
<body class="text-gray-800 relative">

    <!-- Header Section -->
    <header class="bg-blue-900 text-white py-8 px-4 text-center shadow-lg">
        <h1 class="text-3xl md:text-5xl font-extrabold tracking-tight mb-2 uppercase" data-i18n="header_title">
            AI Malaysian Passport Photo
        </h1>
        <p class="text-sm md:text-base italic text-blue-200 font-light">
            <span data-i18n="designed_by">Designed by</span> Fizzi Zain
        </p>

        <!-- Language Switcher -->
        <div class="flex justify-center gap-4 mt-6">
            <button onclick="switchLanguage('en')" id="btn-en" class="lang-btn active flex items-center justify-center gap-2 w-48 py-2 rounded-full font-bold text-sm transition-all hover:bg-white hover:text-blue-900 border border-transparent hover:border-white">
                <span>ðŸ‡¬ðŸ‡§</span> English
            </button>
            <button onclick="switchLanguage('bm')" id="btn-bm" class="lang-btn flex items-center justify-center gap-2 w-48 py-2 rounded-full font-bold text-sm transition-all hover:bg-white hover:text-blue-900 border border-transparent hover:border-white">
                <span>ðŸ‡²ðŸ‡¾</span> Bahasa Malaysia
            </button>
        </div>
    </header>

    <!-- Main Content -->
    <main class="max-w-5xl mx-auto px-4 py-8 space-y-12">

        <!-- Features Info Box (Moved to Main) -->
        <section class="bg-white rounded-xl shadow-md p-6 border-l-4 border-blue-600 max-w-4xl mx-auto">
            <h3 class="text-xl font-bold mb-4 text-blue-900 text-center" data-i18n="why_title">Why Choose This Tool?</h3>
            
            <!-- max-w-fit mx-auto centers the block of text. text-left keeps list items aligned neatly to the left -->
            <ul class="text-left text-gray-700 space-y-3 text-sm md:text-base max-w-fit mx-auto px-2">
                <li class="flex items-start gap-3">
                    <i class="fa-solid fa-microchip mt-1 text-blue-500 shrink-0 w-6 text-center"></i>
                    <span data-i18n="why_1">Powered by advanced AI technology for precision.</span>
                </li>
                <li class="flex items-start gap-3">
                    <i class="fa-solid fa-passport mt-1 text-blue-500 shrink-0 w-6 text-center"></i>
                    <span data-i18n="why_2">Instant compliant Malaysian passport photo download.</span>
                </li>
                <li class="flex items-start gap-3">
                    <i class="fa-solid fa-print mt-1 text-blue-500 shrink-0 w-6 text-center"></i>
                    <span data-i18n="why_3">Auto-generates print-ready A4 sheet (25 copies).</span>
                </li>
                <li class="flex items-start gap-3">
                    <i class="fa-solid fa-house-chimney mt-1 text-blue-500 shrink-0 w-6 text-center"></i>
                    <span data-i18n="why_4">Save time and money - no studio visit required.</span>
                </li>
            </ul>
        </section>

        <!-- Prompt Copy Section -->
        <section class="bg-white rounded-2xl shadow-md p-6 md:p-8">
            <h2 class="text-2xl font-bold text-center mb-6 text-blue-900" data-i18n="step1_title">Step 1: Get Your Prompt</h2>
            <p class="text-center text-gray-600 mb-8" data-i18n="step1_desc">Click a button below to copy the prompt to your clipboard.</p>
            
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                <!-- Man Button -->
                <button onclick="copyPrompt('man')" class="group relative flex flex-col items-center justify-center p-6 border-2 border-blue-100 rounded-xl hover:border-blue-500 hover:bg-blue-50 transition-all">
                    <div class="w-12 h-12 bg-blue-500 text-white rounded-full flex items-center justify-center mb-3 group-hover:scale-110 transition-transform">
                        <i class="fa-solid fa-user-tie"></i>
                    </div>
                    <span class="font-bold text-lg text-blue-900" data-i18n="btn_man">Man</span>
                    <span class="text-xs text-gray-500 mt-1" data-i18n="btn_man_desc">Formal suit, White BG</span>
                    <span id="msg-man" class="absolute bottom-2 text-green-600 text-xs font-bold opacity-0 transition-opacity" data-i18n="copied_msg">Copied!</span>
                </button>

                <!-- Woman Button -->
                <button onclick="copyPrompt('woman')" class="group relative flex flex-col items-center justify-center p-6 border-2 border-pink-100 rounded-xl hover:border-pink-500 hover:bg-pink-50 transition-all">
                    <div class="w-12 h-12 bg-pink-500 text-white rounded-full flex items-center justify-center mb-3 group-hover:scale-110 transition-transform">
                        <i class="fa-solid fa-user"></i>
                    </div>
                    <span class="font-bold text-lg text-pink-900" data-i18n="btn_woman">Woman</span>
                    <span class="text-xs text-gray-500 mt-1" data-i18n="btn_woman_desc">Formal wear, White BG</span>
                    <span id="msg-woman" class="absolute bottom-2 text-green-600 text-xs font-bold opacity-0 transition-opacity" data-i18n="copied_msg">Copied!</span>
                </button>

                <!-- Woman Hijab Button -->
                <button onclick="copyPrompt('hijab')" class="group relative flex flex-col items-center justify-center p-6 border-2 border-emerald-100 rounded-xl hover:border-emerald-500 hover:bg-emerald-50 transition-all">
                    <div class="w-12 h-12 bg-emerald-500 text-white rounded-full flex items-center justify-center mb-3 group-hover:scale-110 transition-transform">
                        <i class="fa-solid fa-user-astronaut"></i> 
                    </div>
                    <span class="font-bold text-lg text-emerald-900" data-i18n="btn_hijab">Woman (Hijab)</span>
                    <span class="text-xs text-gray-500 mt-1" data-i18n="btn_hijab_desc">Tudung, Formal, White BG</span>
                    <span id="msg-hijab" class="absolute bottom-2 text-green-600 text-xs font-bold opacity-0 transition-opacity" data-i18n="copied_msg">Copied!</span>
                </button>
            </div>
        </section>

        <!-- Step 2: Generate Section -->
        <section class="bg-white rounded-2xl shadow-md p-6 md:p-8 text-center">
            <h2 class="text-2xl font-bold mb-6 text-blue-900" data-i18n="step2_title">Step 2: Generate with AI</h2>
            
            <!-- Flow Chart -->
            <div class="flex flex-col md:flex-row items-center justify-center gap-4 mb-8">
                <!-- Step 1 -->
                <div class="flex flex-col items-center max-w-[200px]">
                    <div class="w-16 h-16 bg-blue-100 text-blue-600 rounded-full flex items-center justify-center mb-3 shadow-sm">
                        <i class="fa-solid fa-cloud-arrow-up text-2xl"></i>
                    </div>
                    <p class="text-sm font-semibold text-gray-700 leading-tight" data-i18n="flow_1">Upload Image to AI Website</p>
                </div>

                <!-- Arrow 1 -->
                <i class="fa-solid fa-arrow-right text-gray-300 text-xl hidden md:block"></i>
                <i class="fa-solid fa-arrow-down text-gray-300 text-xl block md:hidden"></i>

                <!-- Step 2 -->
                <div class="flex flex-col items-center max-w-[200px]">
                    <div class="w-16 h-16 bg-purple-100 text-purple-600 rounded-full flex items-center justify-center mb-3 shadow-sm">
                        <i class="fa-solid fa-keyboard text-2xl"></i>
                    </div>
                    <p class="text-sm font-semibold text-gray-700 leading-tight" data-i18n="flow_2">Paste Prompt & Press Enter</p>
                </div>

                <!-- Arrow 2 -->
                <i class="fa-solid fa-arrow-right text-gray-300 text-xl hidden md:block"></i>
                <i class="fa-solid fa-arrow-down text-gray-300 text-xl block md:hidden"></i>

                <!-- Step 3 -->
                <div class="flex flex-col items-center max-w-[200px]">
                    <div class="w-16 h-16 bg-green-100 text-green-600 rounded-full flex items-center justify-center mb-3 shadow-sm">
                        <i class="fa-solid fa-file-arrow-down text-2xl"></i>
                    </div>
                    <p class="text-sm font-semibold text-gray-700 leading-tight" data-i18n="flow_3">Save Image & Return Here</p>
                </div>
            </div>
            
            <div class="flex flex-col md:flex-row justify-center gap-4">
                <!-- Gemini -->
                <a href="https://gemini.google.com/app" target="_blank" class="inline-flex items-center justify-center gap-3 bg-gradient-to-r from-blue-600 to-purple-600 hover:from-blue-700 hover:to-purple-700 text-white px-8 py-4 rounded-xl font-bold text-lg shadow-lg transition-transform hover:-translate-y-1 w-full md:w-auto">
                    <i class="fa-solid fa-wand-magic-sparkles"></i>
                    <span data-i18n="btn_gemini">Gemini</span>
                </a>

                <!-- ChatGPT -->
                <a href="https://chatgpt.com/" target="_blank" class="inline-flex items-center justify-center gap-3 bg-gradient-to-r from-emerald-500 to-teal-600 hover:from-emerald-600 hover:to-teal-700 text-white px-8 py-4 rounded-xl font-bold text-lg shadow-lg transition-transform hover:-translate-y-1 w-full md:w-auto">
                    <i class="fa-solid fa-robot"></i>
                    <span data-i18n="btn_gpt">ChatGPT</span>
                </a>
            </div>
        </section>

        <!-- Editor Section -->
        <section class="bg-white rounded-2xl shadow-xl overflow-hidden">
            <div class="bg-gray-800 text-white p-4 text-center">
                <h2 class="text-xl font-bold" data-i18n="step3_title">Step 3: Crop & Download</h2>
                <p class="text-gray-400 text-sm">Malaysian Standard (35mm x 50mm)</p>
            </div>

            <div class="p-6 md:p-8">
                <!-- Upload Area -->
                <div class="mb-6 flex justify-center">
                    <label class="cursor-pointer bg-blue-600 hover:bg-blue-700 text-white px-6 py-3 rounded-lg shadow transition-colors flex items-center gap-2">
                        <i class="fa-solid fa-cloud-arrow-up"></i>
                        <span data-i18n="upload_btn">Upload Image</span>
                        <input type="file" id="imageInput" accept="image/*" class="hidden" onchange="handleImageUpload(event)">
                    </label>
                </div>

                <!-- Workspace (Hidden Initially) -->
                <div class="flex flex-col items-center gap-6" id="workspace" style="display:none;">
                    
                    <!-- Canvas Area -->
                    <div class="relative w-full max-w-[400px] aspect-[3.5/5] border-4 border-gray-200 rounded-lg shadow-inner bg-gray-100">
                        <div id="canvasWrapper" class="canvas-container w-full h-full relative flex items-center justify-center">
                            <!-- The image is drawn on this canvas -->
                            <canvas id="editorCanvas"></canvas>
                            
                            <!-- The Guide Overlay (SVG) -->
                            <svg class="absolute inset-0 w-full h-full overlay-guide" viewBox="0 0 350 500" preserveAspectRatio="none">
                                <!-- Blue color for guide -->
                                <g stroke="#3b82f6" stroke-width="3" fill="none" stroke-dasharray="5,5">
                                    <!-- Head Oval -->
                                    <ellipse cx="175" cy="220" rx="110" ry="150" />
                                    <!-- Center vertical line -->
                                    <line x1="175" y1="0" x2="175" y2="500" opacity="0.5" />
                                    <!-- Eye Line (Approximate) -->
                                    <line x1="50" y1="200" x2="300" y2="200" opacity="0.5" />
                                    <!-- Shoulder curve estimation -->
                                    <path d="M 15 500 Q 80 400 175 420 Q 270 400 335 500" />
                                </g>
                                <!-- Darkened outside area -->
                                <path d="M0,0 H350 V500 H0 Z M175,220 m-110,0 a110,150 0 1,0 220,0 a110,150 0 1,0 -220,0" fill="rgba(0,0,0,0.2)" stroke="none" fill-rule="evenodd" style="pointer-events:none; stroke-dasharray:none;"/>
                            </svg>
                        </div>
                    </div>

                    <!-- Controls -->
                    <div class="w-full max-w-md space-y-4">
                        <div class="flex items-center gap-3">
                            <i class="fa-solid fa-magnifying-glass-minus text-gray-400"></i>
                            <input type="range" id="zoomSlider" min="0.1" max="3" step="0.01" value="1" class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer accent-blue-600">
                            <i class="fa-solid fa-magnifying-glass-plus text-gray-400"></i>
                        </div>
                        <p class="text-xs text-center text-gray-500" data-i18n="drag_guide">Drag image to position face inside the oval. Use slider to zoom.</p>
                    </div>
                </div>

                <!-- Empty State -->
                <div id="emptyState" class="text-center py-12 border-2 border-dashed border-gray-300 rounded-xl bg-gray-50">
                    <i class="fa-regular fa-image text-4xl text-gray-300 mb-3"></i>
                    <p class="text-gray-500" data-i18n="empty_state">No image uploaded yet.<br>Upload an AI generated image to start.</p>
                </div>

                <!-- Actions (Visible but Dimmed Initially) -->
                <div id="downloadButtonsContainer" class="flex flex-col md:flex-row gap-4 w-full justify-center mt-6 opacity-40 grayscale pointer-events-none cursor-not-allowed transition-all duration-300">
                    <button onclick="downloadImage()" class="bg-green-600 hover:bg-green-700 text-white px-8 py-3 rounded-lg font-bold shadow-lg transition-transform active:scale-95 flex items-center justify-center gap-2 w-full md:w-auto">
                        <i class="fa-solid fa-image"></i> <span data-i18n="download_btn">Download Single Photo</span>
                    </button>
                    
                    <button onclick="downloadPDF()" class="bg-red-600 hover:bg-red-700 text-white px-8 py-3 rounded-lg font-bold shadow-lg transition-transform active:scale-95 flex items-center justify-center gap-2 w-full md:w-auto">
                        <i class="fa-solid fa-file-pdf"></i> <span data-i18n="btn_pdf">Download A4 PDF</span>
                    </button>
                </div>
            </div>
        </section>

        <!-- Step 4: Thank You & Donation -->
        <section class="bg-white rounded-2xl shadow-md p-6 md:p-8 text-center space-y-6">
            <h2 class="text-2xl font-bold text-blue-900" data-i18n="step4_title">Step 4 (Optional) : Thank You!</h2>
            <p class="text-gray-600 max-w-2xl mx-auto" data-i18n="step4_desc">
                I hope this tool helps you get your perfect passport photo easily. 
                If you found this useful, consider supporting the maintenance of this website!
            </p>
            
            <div class="wiggle-container">
                <a href="https://toyyibpay.com/msiaphoto" target="_blank" class="btn-glitter inline-flex items-center gap-2 bg-yellow-400 hover:bg-yellow-500 text-yellow-900 px-8 py-4 rounded-full font-bold shadow-lg transition-all hover:-translate-y-1 transform hover:scale-105">
                    <i class="fa-solid fa-coffee text-xl"></i>
                    <span class="text-lg" data-i18n="coffee_btn">Buy me a Coffee</span>
                </a>
            </div>
        </section>

    </main>

    <!-- Footer -->
    <footer class="text-center pb-8 text-gray-400 text-sm">
        <p data-i18n="footer">&copy; 2025 AI Malaysian Passport Photo. Designed by Fizzi Zain. All rights reserved.</p>
    </footer>

    <!-- Floating Feedback Button -->
    <div class="fixed bottom-5 left-5 z-50">
        <!-- Changed to yellow styles: bg-yellow-400, hover:bg-yellow-500, text-yellow-900 -->
        <button onclick="openFeedbackModal()" class="pulse-btn bg-yellow-400 hover:bg-yellow-500 text-yellow-900 p-4 rounded-full shadow-xl transition-all hover:scale-110 flex items-center justify-center" title="Send Feedback">
            <i class="fa-solid fa-message text-2xl"></i>
        </button>
    </div>

    <!-- Feedback Modal -->
    <div id="feedbackModal" class="modal">
        <div class="modal-content relative w-full max-w-md bg-white rounded-xl shadow-2xl">
            <div class="text-left p-6">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-xl font-bold text-gray-800" data-i18n="feedback_title">Send Feedback</h3>
                    <button onclick="closeFeedbackModal()" class="text-gray-400 hover:text-red-500 text-2xl font-bold">&times;</button>
                </div>
                
                <p class="text-sm text-gray-600 mb-4" data-i18n="feedback_desc">Help us improve! Please let us know what you think.</p>
                
                <form onsubmit="sendFeedback(event)" class="space-y-4">
                    <div>
                        <label class="block text-sm font-bold text-gray-700 mb-1" data-i18n="label_email">Your Email (Required)</label>
                        <input type="email" id="feedbackEmail" required class="w-full p-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:outline-none" placeholder="example@email.com">
                    </div>
                    
                    <div>
                        <label class="block text-sm font-bold text-gray-700 mb-1" data-i18n="label_message">Feedback / Suggestions</label>
                        <textarea id="feedbackMessage" required class="w-full p-2 border border-gray-300 rounded-lg h-32 focus:ring-2 focus:ring-blue-500 focus:outline-none" placeholder="Type your feedback here..."></textarea>
                    </div>
                    
                    <button type="submit" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg transition-colors flex items-center justify-center gap-2">
                        <i class="fa-solid fa-paper-plane"></i> <span data-i18n="btn_send">Send Feedback</span>
                    </button>
                </form>
            </div>
        </div>
    </div>

    <!-- Download Modal -->
    <div id="downloadModal" class="modal">
        <div class="modal-content relative animate-fade-in-down">
            <button onclick="closeDownloadModal()" class="absolute top-2 right-4 text-gray-500 hover:text-red-500 text-3xl font-bold">&times;</button>
            <h3 class="text-xl font-bold mb-2 text-green-700" data-i18n="modal_title">Photo Ready!</h3>
            <p class="text-sm text-gray-600 mb-4" data-i18n="modal_desc">If download didn't start, <b>Right Click / Long Press</b> the image below and select "Save Image".</p>
            
            <div class="border-2 border-gray-200 p-2 inline-block rounded-lg shadow-inner bg-white">
                <img id="finalImage" class="max-h-[50vh] w-auto mx-auto" alt="Passport Photo">
            </div>
            
            <div class="mt-4">
                <button onclick="closeDownloadModal()" class="bg-blue-600 text-white px-6 py-2 rounded-lg hover:bg-blue-700" data-i18n="modal_done">Done</button>
            </div>
        </div>
    </div>

    <!-- Hidden canvas for final processing -->
    <canvas id="outputCanvas" style="display:none;"></canvas>

    <!-- Toast Notification Container -->
    <div id="toast" class="toast"></div>

    <script>
        // --- Toast Functionality ---
        function showToast(message) {
            const toast = document.getElementById("toast");
            toast.textContent = message;
            toast.className = "toast show";
            setTimeout(function(){ toast.className = toast.className.replace("show", ""); }, 3000);
        }

        // --- Translations ---
        const translations = {
            en: {
                header_title: "AI Malaysian Passport Photo",
                designed_by: "Designed by",
                
                // New Why Section
                why_title: "Why Choose This Tool?",
                why_1: "Powered by advanced AI technology for precision.",
                why_2: "Instant compliant Malaysian passport photo download.",
                why_3: "Auto-generates print-ready A4 sheet (25 copies).",
                why_4: "Save time and money - no studio visit required.",

                // Feedback
                feedback_title: "Send Feedback",
                feedback_desc: "Help us improve! Please let us know what you think.",
                label_email: "Your Email (Required)",
                label_message: "Feedback / Suggestions",
                btn_send: "Send via Email App",

                step1_title: "Step 1: Get Your Prompt",
                step1_desc: "Click a button below to copy the prompt to your clipboard.",
                btn_man: "Man",
                btn_man_desc: "Formal suit, White BG",
                btn_woman: "Woman",
                btn_woman_desc: "Formal wear, White BG",
                btn_hijab: "Woman (Hijab)",
                btn_hijab_desc: "Tudung, Formal, White BG",
                copied_msg: "Copied!",
                step2_title: "Step 2: Generate with AI",
                // Removed old desc, using flow text now
                flow_1: "Upload Image to AI Website",
                flow_2: "Paste Prompt & Generate",
                flow_3: "Save Image & Return Here",
                btn_gemini: "Gemini",
                btn_gpt: "ChatGPT",
                step3_title: "Step 3: Crop & Download",
                upload_btn: "Upload Image",
                drag_guide: "Drag image to position face inside the oval. Use slider to zoom.",
                download_btn: "Download Single Photo",
                btn_pdf: "Download A4 PDF (25 pcs)",
                empty_state: "No image uploaded yet.<br>Upload an AI generated image to start.",
                step4_title: "Step 4 (Optional) : Thank You!",
                step4_desc: "I hope this tool helps you get your perfect passport photo easily. If you found this useful, consider supporting the maintenance of this website!",
                coffee_btn: "Buy me a Coffee",
                footer: "&copy; 2025 AI Malaysian Passport Photo. Designed by Fizzi Zain. All rights reserved.",
                modal_title: "Photo Ready!",
                modal_desc: "Automatic download attempted. If it didn't work, <b>Right Click / Long Press</b> the image below and select \"Save Image\".",
                modal_done: "Done"
            },
            bm: {
                header_title: "AI Malaysian Passport Photo",
                designed_by: "Direka oleh",

                // New Why Section (BM)
                why_title: "Mengapa Pilih Alat Ini?",
                why_1: "Dikuasakan oleh teknologi AI canggih untuk ketepatan.",
                why_2: "Muat turun foto pasport Malaysia yang patuh piawaian.",
                why_3: "Menjana helaian A4 sedia cetak (25 keping) secara automatik.",
                why_4: "Jimat masa dan wang - tiada lagi kunjungan ke kedai gambar.",

                // Feedback
                feedback_title: "Hantar Maklum Balas",
                feedback_desc: "Bantu kami menambah baik! Sila beritahu pendapat anda.",
                label_email: "Emel Anda (Wajib)",
                label_message: "Maklum Balas / Cadangan",
                btn_send: "Hantar melalui Aplikasi Emel",

                step1_title: "Langkah 1: Dapatkan Arahan (Prompt)",
                step1_desc: "Klik butang di bawah untuk menyalin arahan ke papan keratan.",
                btn_man: "Lelaki",
                btn_man_desc: "Sut formal, Latar Putih",
                btn_woman: "Wanita",
                btn_woman_desc: "Pakaian formal, Latar Putih",
                btn_hijab: "Wanita (Bertudung)",
                btn_hijab_desc: "Tudung, Formal, Latar Putih",
                copied_msg: "Disalin!",
                step2_title: "Langkah 2: Jana dengan AI",
                // Removed old desc
                flow_1: "Muat Naik Gambar ke Web AI",
                flow_2: "Tampal Arahan & Jana",
                flow_3: "Simpan Gambar & Kembali Sini",
                btn_gemini: "Gemini",
                btn_gpt: "ChatGPT",
                step3_title: "Langkah 3: Potong & Muat Turun",
                upload_btn: "Muat Naik Gambar",
                drag_guide: "Seret gambar untuk meletakkan muka di dalam bujur. Gunakan pelaras untuk zum.",
                download_btn: "Muat Turun Foto Tunggal",
                btn_pdf: "Muat Turun PDF A4 (25 keping)",
                empty_state: "Tiada gambar dimuat naik.<br>Muat naik gambar yang dijana AI untuk bermula.",
                step4_title: "Langkah 4 (Pilihan) : Terima Kasih!",
                step4_desc: "Saya harap alat ini membantu anda mendapatkan foto pasport yang sempurna. Jika berguna, pertimbangkan untuk menyokong laman web ini!",
                coffee_btn: "Belanja Saya Kopi",
                footer: "&copy; 2025 AI Malaysian Passport Photo. Direka oleh Fizzi Zain. Hak cipta terpelihara.",
                modal_title: "Foto Sedia!",
                modal_desc: "Muat turun automatik dicuba. Jika tidak berjaya, <b>Klik Kanan / Tekan Lama</b> gambar di bawah dan pilih \"Save Image\".",
                modal_done: "Selesai"
            }
        };

        function switchLanguage(lang) {
            // Update Text
            const elements = document.querySelectorAll('[data-i18n]');
            elements.forEach(el => {
                const key = el.getAttribute('data-i18n');
                if (translations[lang][key]) {
                    el.innerHTML = translations[lang][key];
                }
            });

            // Update Buttons State
            document.getElementById('btn-en').classList.remove('active');
            document.getElementById('btn-bm').classList.remove('active');
            document.getElementById(`btn-${lang}`).classList.add('active');
        }

        // --- Prompts ---
        const prompts = {
            man: "Convert image to standing up and looking to camera, wearing a formal man wear, head to waist view, use 100% accurate face. HD Photo. Solid white as background.",
            woman: "Convert image to standing up and looking to camera, wearing a formal woman wear, head to waist view, use 100% accurate face. HD Photo. Solid white as background.",
            hijab: "Convert image to standing up and looking to camera, wearing a formal woman wear, wearing hijab. head to waist view, use 100% accurate face. HD Photo. Solid white as background."
        };

        // --- Copy Functionality ---
        function copyPrompt(type) {
            const text = prompts[type];
            if (navigator.clipboard && window.isSecureContext) {
                navigator.clipboard.writeText(text).then(() => showCopied(type));
            } else {
                const textArea = document.createElement("textarea");
                textArea.value = text;
                textArea.style.position = "fixed";
                textArea.style.left = "-9999px";
                document.body.appendChild(textArea);
                textArea.focus();
                textArea.select();
                try {
                    document.execCommand('copy');
                    showCopied(type);
                } catch (err) {
                    // Fallback to toast instead of alert
                    showToast("Please manually copy this: " + text);
                }
                document.body.removeChild(textArea);
            }
        }

        function showCopied(type) {
            const msg = document.getElementById(`msg-${type}`);
            msg.style.opacity = '1';
            setTimeout(() => {
                msg.style.opacity = '0';
            }, 2000);
        }

        // --- Image Editor Logic ---
        
        const PASSPORT_RATIO = 35 / 50;
        const OUTPUT_WIDTH = 413; // Approx 35mm at 300dpi
        const OUTPUT_HEIGHT = 591; // Approx 50mm at 300dpi

        let canvas, ctx;
        let img = new Image();
        let scale = 1;
        let position = { x: 0, y: 0 };
        let isDragging = false;
        let startPos = { x: 0, y: 0 };
        
        window.onload = function() {
            canvas = document.getElementById('editorCanvas');
            ctx = canvas.getContext('2d');
            // Initial size setup if visible, otherwise handled in upload
            const container = document.getElementById('canvasWrapper');
            if(container.clientWidth > 0) {
                 canvas.width = container.clientWidth;
                 canvas.height = container.clientHeight; 
            }
        };

        window.onresize = function() {
            if(img.src) {
                const container = document.getElementById('canvasWrapper');
                canvas.width = container.clientWidth;
                canvas.height = container.clientHeight;
                draw();
            }
        };

        function handleImageUpload(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                img = new Image();
                img.onload = function() {
                    scale = 1;
                    position = { x: 0, y: 0 };
                    document.getElementById('zoomSlider').value = 1;
                    
                    document.getElementById('workspace').style.display = 'flex';
                    document.getElementById('emptyState').style.display = 'none';
                    
                    // Enable Download Buttons
                    const btnContainer = document.getElementById('downloadButtonsContainer');
                    btnContainer.classList.remove('opacity-40', 'grayscale', 'pointer-events-none', 'cursor-not-allowed');

                    const container = document.getElementById('canvasWrapper');
                    canvas.width = container.clientWidth;
                    canvas.height = container.clientHeight;

                    const scaleX = canvas.width / img.width;
                    const scaleY = canvas.height / img.height;
                    const initialScale = Math.max(scaleX, scaleY);
                    
                    scale = initialScale;
                    position.x = (canvas.width - img.width * scale) / 2;
                    position.y = (canvas.height - img.height * scale) / 2;

                    draw();
                    initInteractions();
                };
                img.src = e.target.result;
            };
            reader.readAsDataURL(file);
        }

        function draw() {
            if (!img.src) return;
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            ctx.drawImage(img, position.x, position.y, img.width * scale, img.height * scale);
        }

        function initInteractions() {
            const container = document.getElementById('canvasWrapper');
            const slider = document.getElementById('zoomSlider');

            slider.oninput = function() {
                const zoomFactor = parseFloat(this.value);
                const cx = canvas.width / 2;
                const cy = canvas.height / 2;
                const imgCx = (cx - position.x) / scale;
                const imgCy = (cy - position.y) / scale;

                const scaleX = canvas.width / img.width;
                const scaleY = canvas.height / img.height;
                const baseScale = Math.max(scaleX, scaleY);
                
                const newScale = baseScale * zoomFactor;

                position.x = cx - (imgCx * newScale);
                position.y = cy - (imgCy * newScale);
                scale = newScale;
                draw();
            };

            container.addEventListener('mousedown', startDrag);
            window.addEventListener('mousemove', drag);
            window.addEventListener('mouseup', endDrag);

            container.addEventListener('touchstart', (e) => startDrag(e.touches[0]));
            window.addEventListener('touchmove', (e) => {
                if(isDragging) e.preventDefault(); 
                drag(e.touches[0]);
            }, { passive: false });
            window.addEventListener('touchend', endDrag);
        }

        function startDrag(e) {
            isDragging = true;
            startPos = { x: e.clientX - position.x, y: e.clientY - position.y };
            document.getElementById('canvasWrapper').style.cursor = 'grabbing';
        }

        function drag(e) {
            if (!isDragging) return;
            position.x = e.clientX - startPos.x;
            position.y = e.clientY - startPos.y;
            draw();
        }

        function endDrag() {
            isDragging = false;
            document.getElementById('canvasWrapper').style.cursor = 'grab';
        }

        // --- Prepare Image Data for Download/PDF ---
        function getCroppedImageData() {
            if (!img.src) return null;

            const outCanvas = document.getElementById('outputCanvas');
            const outCtx = outCanvas.getContext('2d');

            outCanvas.width = OUTPUT_WIDTH;
            outCanvas.height = OUTPUT_HEIGHT;

            outCtx.fillStyle = "#ffffff";
            outCtx.fillRect(0, 0, OUTPUT_WIDTH, OUTPUT_HEIGHT);

            // Scale from Editor View to High-Res Output
            const ratio = OUTPUT_WIDTH / canvas.width;

            outCtx.drawImage(
                img,
                position.x * ratio,
                position.y * ratio,
                img.width * scale * ratio,
                img.height * scale * ratio
            );
            
            return outCanvas.toDataURL('image/jpeg', 0.95);
        }

        // --- UPDATED Download Logic (Blob Method) ---
        function downloadImage() {
            if (!img.src) {
                showToast("Please upload an image first!");
                return;
            }

            // Regenerate to ensure fresh data
            getCroppedImageData(); 
            const outCanvas = document.getElementById('outputCanvas');

            // 1. Generate Blob for Download (More robust)
            outCanvas.toBlob(function(blob) {
                const url = URL.createObjectURL(blob);
                
                // Show Modal immediately
                const previewUrl = outCanvas.toDataURL('image/jpeg', 0.95);
                const modal = document.getElementById('downloadModal');
                const finalImg = document.getElementById('finalImage');
                finalImg.src = previewUrl;
                modal.classList.add('flex');

                // Try Auto Download
                try {
                    const link = document.createElement('a');
                    link.download = 'passport-photo-malaysia.jpg';
                    link.href = url;
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                    
                    // Cleanup
                    setTimeout(() => URL.revokeObjectURL(url), 1000);
                } catch (e) {
                    console.log("Auto-download blocked, user must use modal.");
                }
            }, 'image/jpeg', 0.95);
        }

        // --- NEW: Download PDF Function ---
        function downloadPDF() {
            if (!img.src) {
                showToast("Please upload an image first!");
                return;
            }

            // Ensure jspdf is loaded
            if (!window.jspdf) {
                showToast("PDF Library loading... please try again in a second.");
                return;
            }

            const imageData = getCroppedImageData();
            const { jsPDF } = window.jspdf;
            
            // Create A4 PDF (Portrait)
            // A4 size: 210mm x 297mm
            const doc = new jsPDF({
                orientation: "portrait",
                unit: "mm",
                format: "a4"
            });

            // Passport Size: 35mm x 50mm
            const pWidth = 35;
            const pHeight = 50;

            // Grid: 5 columns, 5 rows (Total 25 images)
            const columns = 5;
            const rows = 5;
            
            // Calculate Centering
            // Total Grid Width = 35 * 5 = 175mm
            // Total Grid Height = 50 * 5 = 250mm
            // Page Width = 210mm -> Margin X = (210 - 175) / 2 = 17.5mm
            // Page Height = 297mm -> Margin Y = (297 - 250) / 2 = 23.5mm
            
            const startX = 17.5;
            const startY = 23.5;

            // Loop to add images
            for (let r = 0; r < rows; r++) {
                for (let c = 0; c < columns; c++) {
                    const x = startX + (c * pWidth);
                    const y = startY + (r * pHeight);
                    
                    // Add image to PDF
                    // 'JPEG', x, y, width, height
                    doc.addImage(imageData, 'JPEG', x, y, pWidth, pHeight);

                    // Add black stroke for cutting
                    doc.setDrawColor(0, 0, 0); // Black color
                    doc.setLineWidth(0.1); // Thin line (0.1mm)
                    doc.rect(x, y, pWidth, pHeight); // Draw border
                }
            }

            // Save PDF
            doc.save("passport-photos-a4.pdf");
        }

        function closeDownloadModal() {
            const modal = document.getElementById('downloadModal');
            modal.classList.remove('flex');
        }

        // --- Feedback Functions ---
        function openFeedbackModal() {
            const modal = document.getElementById('feedbackModal');
            modal.classList.add('flex');
        }

        function closeFeedbackModal() {
            const modal = document.getElementById('feedbackModal');
            modal.classList.remove('flex');
        }

        function sendFeedback(e) {
            e.preventDefault();
            const email = document.getElementById('feedbackEmail').value;
            const message = document.getElementById('feedbackMessage').value;
            
            if (!email || !message) {
                showToast("Please fill in all fields.");
                return;
            }

            const subject = encodeURIComponent("Feedback: AI Malaysian Passport Photo");
            const body = encodeURIComponent(`User Email: ${email}\n\nFeedback:\n${message}`);
            
            window.location.href = `mailto:desprint96@gmail.com?subject=${subject}&body=${body}`;
            
            setTimeout(() => {
                closeFeedbackModal();
                document.getElementById('feedbackMessage').value = ""; // Clear message only
            }, 1000);
        }

    </script>
</body>
</html>
